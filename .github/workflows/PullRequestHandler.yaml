name: 'Pull Request Build'

on:
  pull_request:
    branches: [ 'main', 'releases/*', 'features/*' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

defaults:
  run:
    shell: powershell

permissions:
  actions: read
  contents: read
  id-token: write
  pull-requests: read
  security-events: write
  packages: read

env:
  workflowDepth: 2
  ALGoOrgSettings: ${{ vars.ALGoOrgSettings }}
  ALGoRepoSettings: ${{ vars.ALGoRepoSettings }}

jobs:
  PregateCheck:
    if: (github.event.pull_request.base.repo.full_name != github.event.pull_request.head.repo.full_name) && (github.event_name != 'pull_request')
    runs-on: windows-latest
    steps:
      - uses: spetersenms/AL-Go/Actions/VerifyPRChanges@CodeCoverage

  Initialization:
    needs: [ PregateCheck ]
    if: (!failure() && !cancelled())
    runs-on: [ windows-latest ]
    outputs:
      projects: ${{ steps.determineProjectsToBuild.outputs.ProjectsJson }}
      projectDependenciesJson: ${{ steps.determineProjectsToBuild.outputs.ProjectDependenciesJson }}
      buildOrderJson: ${{ steps.determineProjectsToBuild.outputs.BuildOrderJson }}
      baselineWorkflowRunId: ${{ steps.determineProjectsToBuild.outputs.BaselineWorkflowRunId }}
      baselineWorkflowSHA: ${{ steps.determineProjectsToBuild.outputs.BaselineWorkflowSHA }}
      workflowDepth: ${{ steps.DetermineWorkflowDepth.outputs.WorkflowDepth }}
      artifactsRetentionDays: ${{ steps.DetermineWorkflowDepth.outputs.ArtifactsRetentionDays }}
      telemetryScopeJson: ${{ steps.init.outputs.telemetryScopeJson }}
      trackALAlertsInGitHub: ${{ steps.SetALCodeAnalysisVar.outputs.trackALAlertsInGitHub }}
    steps:
      - name: Dump Workflow Information
        uses: spetersenms/AL-Go/Actions/DumpWorkflowInfo@CodeCoverage
        with:
          shell: powershell

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true
          ref: ${{ github.event_name == 'pull_request' && github.sha || format('refs/pull/{0}/merge', github.event.pull_request.number) }}

      - name: Initialize the workflow
        id: init
        uses: spetersenms/AL-Go/Actions/WorkflowInitialize@CodeCoverage
        with:
          shell: powershell

      - name: Read settings
        id: ReadSettings
        uses: spetersenms/AL-Go/Actions/ReadSettings@CodeCoverage
        with:
          shell: powershell
          get: shortLivedArtifactsRetentionDays,trackALAlertsInGitHub

      - name: Set AL Code Analysis Var output
        id: SetALCodeAnalysisVar
        run: |
          Write-Host "trackALAlertsInGitHub environment variable: '$($env:trackALAlertsInGitHub)'"
          Add-Content -Encoding UTF8 -Path $env:GITHUB_OUTPUT -Value "trackALAlertsInGitHub=$($env:trackALAlertsInGitHub)"

      - name: Determine Workflow Depth
        id: DetermineWorkflowDepth
        run: |
          Add-Content -Encoding UTF8 -Path $env:GITHUB_OUTPUT -Value "WorkflowDepth=$($env:workflowDepth)"
          Add-Content -Encoding UTF8 -Path $env:GITHUB_OUTPUT -Value "ArtifactsRetentionDays=$($env:shortLivedArtifactsRetentionDays)"

      - name: Determine Projects To Build
        id: determineProjectsToBuild
        uses: spetersenms/AL-Go/Actions/DetermineProjectsToBuild@CodeCoverage
        with:
          shell: powershell
          maxBuildDepth: ${{ env.workflowDepth }}

  Build1:
    needs: [ Initialization ]
    if: (!failure()) && (!cancelled()) && fromJson(needs.Initialization.outputs.buildOrderJson)[0].projectsCount > 0
    strategy:
      matrix:
        include: ${{ fromJson(needs.Initialization.outputs.buildOrderJson)[0].buildDimensions }}
      fail-fast: false
    name: Build ${{ matrix.projectName }} (${{ matrix.buildMode }})
    uses: ./.github/workflows/_BuildALGoProject.yaml
    secrets: inherit
    with:
      shell: ${{ matrix.githubRunnerShell }}
      runsOn: ${{ matrix.githubRunner }}
      checkoutRef: ${{ github.event_name == 'pull_request' && github.sha || format('refs/pull/{0}/merge', github.event.pull_request.number) }}
      project: ${{ matrix.project }}
      projectName: ${{ matrix.projectName }}
      buildMode: ${{ matrix.buildMode }}
      projectDependenciesJson: ${{ needs.Initialization.outputs.projectDependenciesJson }}
      baselineWorkflowRunId: ${{ needs.Initialization.outputs.baselineWorkflowRunId }}
      baselineWorkflowSHA: ${{ needs.Initialization.outputs.baselineWorkflowSHA }}
      secrets: 'licenseFileUrl,keyVaultCertificateUrl,*keyVaultCertificatePassword,keyVaultClientId,gitHubPackagesContext,applicationInsightsConnectionString'
      artifactsRetentionDays: ${{ fromJson(needs.Initialization.outputs.artifactsRetentionDays) }}
      artifactsNameSuffix: 'PR${{ github.event.number }}'
      needsContext:  ${{ toJson(needs) }}
      useArtifactCache: true

  Build:
    needs: [ Initialization, Build1 ]
    if: (!failure()) && (!cancelled()) && (needs.Build1.result == 'success' || needs.Build1.result == 'skipped') && fromJson(needs.Initialization.outputs.buildOrderJson)[1].projectsCount > 0
    strategy:
      matrix:
        include: ${{ fromJson(needs.Initialization.outputs.buildOrderJson)[1].buildDimensions }}
      fail-fast: false
    name: Build ${{ matrix.projectName }} (${{ matrix.buildMode }})
    uses: ./.github/workflows/_BuildALGoProject.yaml
    secrets: inherit
    with:
      shell: ${{ matrix.githubRunnerShell }}
      runsOn: ${{ matrix.githubRunner }}
      checkoutRef: ${{ github.event_name == 'pull_request' && github.sha || format('refs/pull/{0}/merge', github.event.pull_request.number) }}
      project: ${{ matrix.project }}
      projectName: ${{ matrix.projectName }}
      buildMode: ${{ matrix.buildMode }}
      projectDependenciesJson: ${{ needs.Initialization.outputs.projectDependenciesJson }}
      baselineWorkflowRunId: ${{ needs.Initialization.outputs.baselineWorkflowRunId }}
      baselineWorkflowSHA: ${{ needs.Initialization.outputs.baselineWorkflowSHA }}
      secrets: 'licenseFileUrl,keyVaultCertificateUrl,*keyVaultCertificatePassword,keyVaultClientId,gitHubPackagesContext,applicationInsightsConnectionString'
      artifactsRetentionDays: ${{ fromJson(needs.Initialization.outputs.artifactsRetentionDays) }}
      artifactsNameSuffix: 'PR${{ github.event.number }}'
      needsContext:  ${{ toJson(needs) }}
      useArtifactCache: true

  CodeAnalysisUpload:
    needs: [ Initialization, Build ]
    if: (!cancelled()) && (needs.Initialization.outputs.trackALAlertsInGitHub == 'True')
    runs-on: [ windows-latest ]
    name: Code Analysis Processing
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ format('refs/pull/{0}/head', github.event.pull_request.number) }}

      - name: Download artifacts - ErrorLogs
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        if: (success() || failure())
        with:
          pattern: '*-*ErrorLogs-*'
          path: '${{ github.workspace }}/ErrorLogs/'
          merge-multiple: true

      - name: Process AL Code Analysis Logs
        id: ProcessALCodeAnalysisLogs
        if: (success() || failure())
        uses: spetersenms/AL-Go/Actions/ProcessALCodeAnalysisLogs@CodeCoverage
        with:
          shell: powershell

      - name: Upload SARIF file to GitHub
        uses: github/codeql-action/upload-sarif@v4
        if: (success() || failure()) && (hashFiles(format('{0}/ErrorLogs/output.sarif.json',github.workspace)) != '')
        with:
          sarif_file: '${{ github.workspace }}/ErrorLogs/output.sarif.json'
          category: "ALCodeAnalysis"
          ref: ${{ format('refs/pull/{0}/head', github.event.pull_request.number) }}
          sha: ${{ github.event.pull_request.head.sha }}

  MergeCoverage:
    needs: [ Initialization, Build ]
    if: (!cancelled()) && (needs.Build.result == 'success' || needs.Build.result == 'skipped' || needs.Build.result == 'failure')
    runs-on: [ windows-latest ]
    name: Merge Code Coverage
    env:
      BUILD_RESULT: ${{ needs.Build.result }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ format('refs/pull/{0}/head', github.event.pull_request.number) }}

      - name: Download coverage artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: '*CodeCoverage*'
          path: '${{ github.workspace }}/.coverage-inputs/'

      - name: Merge Coverage Summaries
        if: hashFiles('.coverage-inputs/**/cobertura.xml') != ''
        uses: spetersenms/AL-Go/Actions/MergeCoverageSummaries@CodeCoverage
        with:
          shell: powershell
          coveragePath: '${{ github.workspace }}/.coverage-inputs'

      - name: Publish merged coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: hashFiles('.coverage-inputs/_merged/cobertura.xml') != ''
        with:
          name: MergedCodeCoverage
          path: '${{ github.workspace }}/.coverage-inputs/_merged/'
          if-no-files-found: ignore

  StatusCheck:
    needs: [ Initialization, Build, MergeCoverage ]
    if: (!cancelled())
    runs-on: [ windows-latest ]
    name: Pull Request Status Check
    steps:
      - name: Pull Request Status Check
        id: PullRequestStatusCheck
        uses: spetersenms/AL-Go/Actions/PullRequestStatusCheck@CodeCoverage
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          shell: powershell

      - name: Finalize the workflow
        id: PostProcess
        uses: spetersenms/AL-Go/Actions/WorkflowPostProcess@CodeCoverage
        if: success() || failure()
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          shell: powershell
          telemetryScopeJson: ${{ needs.Initialization.outputs.telemetryScopeJson }}
          currentJobContext: ${{ toJson(job) }}
