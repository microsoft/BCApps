name: 'Restart Pull Request Status Check'

on:
  schedule:
    - cron: '0 0 */3 * *' # Run every 3 days at midnight UTC
  workflow_dispatch: # Allow manual trigger for testing

permissions:
  actions: write
  checks: read
  contents: read
  pull-requests: read

defaults:
  run:
    shell: pwsh

jobs:
  RestartStatusChecks:
    runs-on: ubuntu-latest
    name: Restart Stale PR Status Checks
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Check and Restart Status Checks
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"
          Set-StrictMode -Version 2.0

          Write-Host "Fetching open pull requests..."

          # Get all open pull requests
          $prs = gh pr list --state open --json number,headRefName,title,url --limit 1000 | ConvertFrom-Json

          Write-Host "Found $($prs.Count) open pull requests"

          if ($prs.Count -eq 0) {
            Write-Host "No open pull requests found, exiting"
            exit 0
          }

          $now = [DateTime]::UtcNow
          $thresholdHours = 72
          $restarted = 0
          $failed = 0
          $maxRetries = 3

          foreach ($pr in $prs) {
            Write-Host ""
            Write-Host "Checking PR #$($pr.number): $($pr.title)"

            # Get checks for this PR
            try {
              $checks = gh pr checks $pr.number --json name,status,conclusion,completedAt,detailsUrl | ConvertFrom-Json
            }
            catch {
              Write-Host "  ✗ Failed to get checks for PR: $_"
              $failed++
              continue
            }

            # Find the "Pull Request Status Check"
            $statusCheck = $checks | Where-Object { $_.name -eq "Pull Request Status Check" }

            if (-not $statusCheck) {
              Write-Host "  No 'Pull Request Status Check' found for this PR"
              continue
            }

            Write-Host "  Check status: $($statusCheck.status), Conclusion: $($statusCheck.conclusion)"

            # Check if the check is completed and successful
            if ($statusCheck.status -ne "COMPLETED") {
              Write-Host "  Check is still running, skipping"
              continue
            }

            if ($statusCheck.conclusion -ne "SUCCESS") {
              Write-Host "  Check conclusion is '$($statusCheck.conclusion)', not 'SUCCESS', skipping"
              continue
            }

            # Check the age of the completion
            if (-not $statusCheck.completedAt) {
              Write-Host "  No completion time available, skipping"
              continue
            }

            $completedAt = [DateTime]::Parse($statusCheck.completedAt, [System.Globalization.CultureInfo]::InvariantCulture)
            $ageInHours = ($now - $completedAt).TotalHours

            Write-Host "  Completed at: $completedAt UTC (Age: $([Math]::Round($ageInHours, 2)) hours)"

            if ($ageInHours -gt $thresholdHours) {
              Write-Host "  Status check is older than $thresholdHours hours, requesting rerun..."

              # Try to rerequest the check with retries
              $success = $false
              for ($retry = 0; $retry -lt $maxRetries; $retry++) {
                try {
                  if ($retry -gt 0) {
                    # Exponential backoff: 2s, 4s, 8s
                    $delaySeconds = 2 * [Math]::Pow(2, $retry - 1)
                    Write-Host "  Retry attempt $($retry + 1)/$maxRetries (waiting $delaySeconds seconds)..."
                    Start-Sleep -Seconds $delaySeconds
                  }

                  # Rerequest the check by re-running the workflow
                  # First, get the workflow run ID from the check details URL
                  if ($statusCheck.detailsUrl -match '/runs/(\d+)') {
                    $runId = $matches[1]
                    # Validate run ID is a positive integer
                    if ([int]$runId -gt 0) {
                      gh api --method POST "/repos/${{ github.repository }}/actions/runs/$runId/rerun" | Out-Null
                      Write-Host "  ✓ Successfully triggered re-run of workflow (run ID: $runId)"
                      $restarted++
                      $success = $true
                      break
                    }
                    else {
                      Write-Host "  ✗ Invalid run ID extracted: $runId"
                      $failed++
                      break
                    }
                  }
                  else {
                    Write-Host "  ✗ Could not extract run ID from details URL: $($statusCheck.detailsUrl)"
                    $failed++
                    break
                  }
                }
                catch {
                  $errorMsg = $_.Exception.Message
                  if ($retry -eq $maxRetries - 1) {
                    Write-Host "  ✗ Failed to restart workflow after $maxRetries attempts: $errorMsg"
                    $failed++
                  }
                  else {
                    Write-Host "  ⚠ Attempt $($retry + 1) failed: $errorMsg"
                  }
                }
              }
            }
            else {
              Write-Host "  Status check is recent enough, no action needed"
            }
          }

          Write-Host ""
          Write-Host "Summary:"
          Write-Host "  ✓ Successfully restarted: $restarted workflow run(s)"
          Write-Host "  ✗ Failed attempts: $failed"
